# Reform Service - Exercise Form Analysis Backend

**Version:** 0.1.0 (v0 Launch)

## Architecture Overview

This architecture represents the v0 launch structure for Reform Service - the backend API service for exercise form analysis using LLM and Computer Vision.

### Directory Structure

**Root Level:**
- `requirements.txt` - Python dependencies
- `src/` - Source code directory
  - `app.py` - FastAPI application entry point (production server)
- `tst/` - Test code directory
- `venv/` - Python virtual environment (not committed to git)

### Layer 0: Source Components (`src/`)

#### Shared Components (`src/shared/`)
- **live_video/**: Receives and processes streamed frames from frontend
- **pose_estimation/**: Pose estimation component (shared across all exercises) - detects body parts and keypoints from video frames
- **upload_video/**: Receives and processes uploaded video files from frontend

#### Exercise-Specific Components

**src/exercise_1/**: Exercise 1 specific components
- **calculation/**: Uses pose estimation data points to determine form correctness
- **llm_form_analysis/**: LLM-based form analysis specific to Exercise 1
- **feedback/**: Feedback generation specific to Exercise 1

**src/exercise_2/**: Exercise 2 specific components
- **calculation/**: Uses pose estimation data points to determine form correctness
- **llm_form_analysis/**: LLM-based form analysis specific to Exercise 2
- **feedback/**: Feedback generation specific to Exercise 2

**src/exercise_3/**: Exercise 3 specific components
- **calculation/**: Uses pose estimation data points to determine form correctness
- **llm_form_analysis/**: LLM-based form analysis specific to Exercise 3
- **feedback/**: Feedback generation specific to Exercise 3

### Test Structure (`tst/`)
- **tst/**: Test directory mirroring `src/` structure
- Tests are organized in `__tests__/` directories at the component level
- All test files must use the `_test.py` suffix (e.g., `calculation_test.py`)
- Tests are placed at the component level (where code files are), not at intermediate directory levels

## Two Separate Features

### Feature 1: Live Streaming
- **Input**: Real-time camera frames streamed from frontend
- **Backend Entry**: `src/shared/live_video/` - receives streamed frames
- **Processing**: Same backend pipeline (pose estimation → calculation → LLM → feedback)

### Feature 2: Video Upload
- **Input**: Uploaded video file from frontend
- **Backend Entry**: `src/shared/upload_video/` - receives uploaded video
- **Processing**: Same backend pipeline (pose estimation → calculation → LLM → feedback)

**Shared Backend Pipeline**: Both features converge at the shared backend components (pose_estimation, exercise-specific processing, feedback).

## Technology Stack

### Core Framework
- **FastAPI**: Modern, fast web framework for building APIs
- **Uvicorn**: ASGI server that runs the FastAPI application
- **Python 3.14+**: Programming language

### Dependencies
- **Computer Vision**: OpenCV, scikit-image (MediaPipe available for Python <3.14)
- **LLM/AI**: OpenAI, Anthropic
- **Video Processing**: FFmpeg, imageio
- **Testing**: pytest, pytest-cov

## Getting Started

### Prerequisites
- Python 3.14+ (or Python 3.11/3.12 for MediaPipe support)
- pip (Python package manager)

### Installation

1. **Clone the repository** (if not already done)
   ```bash
   git clone <repository-url>
   cd reform-service
   ```

2. **Create a virtual environment**
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

### Running the Server

#### Development Mode (with auto-reload)
```bash
source venv/bin/activate
uvicorn src.app:app --host 127.0.0.1 --port 8000 --reload
```

#### Production Mode
```bash
source venv/bin/activate
uvicorn src.app:app --host 0.0.0.0 --port 8000
```

Or using Python directly:
```bash
cd src
python app.py
```

### API Endpoints

- **Health Check**: `GET /health` - Returns `{"status": "healthy"}`
- **Root**: `GET /` - Returns API status message
- **API Documentation**: `GET /docs` - Interactive Swagger UI (auto-generated by FastAPI)
- **Alternative Docs**: `GET /redoc` - ReDoc documentation

### CORS Configuration

The server is configured to accept requests from:
- `http://localhost:3000` (React development server)

To modify CORS settings, edit `app.py` and update the `allow_origins` list in the CORS middleware.

## Testing

Run tests using pytest:
```bash
source venv/bin/activate
pytest tst/
```

Run tests with coverage:
```bash
pytest tst/ --cov=src
```

## Coding Constraints

### Technology Stack
1. **Main Framework**: FastAPI with Python
2. **File Extensions**: 
   - Python modules: `.py`
   - Test files: `_test.py`

### Function Constraints
1. **Function Length**: Each function should be written under **20 lines**
2. **External Libraries**: Use libraries from `requirements.txt` when needed
3. **File Organization**: Functions should be split up into different files whenever possible

### Test File Naming
1. **Test Files**: All test files must use the `_test.py` suffix (e.g., `calculation_test.py`)
2. **Test Location**: Test files are located in `tst/` directory, mirroring the `src/` structure
3. **Test Organization**: Tests are placed in `__tests__/` directories at the component level

## Common Processes

### Camera Streaming (Common to All Exercises)
When camera frames are streamed from the Frontend:
1. Frames are received via `src/shared/live_video/`
2. Frames are processed through pose estimation (`src/shared/pose_estimation/`)
3. Exercise-specific calculation and analysis occurs
4. Feedback is generated and returned to frontend
5. This process is shared/common across all exercise instances

### Video Upload Processing
When a video file is uploaded from the Frontend:
1. Video is received via `src/shared/upload_video/`
2. Video is processed to extract frames
3. Frames go through the same pipeline as live streaming
4. Feedback is generated and returned to frontend

## Dependencies

See `requirements.txt` for the complete list of dependencies. Key dependencies include:

- **FastAPI** - Web framework
- **Uvicorn** - ASGI server
- **OpenCV** - Computer vision
- **OpenAI/Anthropic** - LLM integration
- **Pytest** - Testing framework

**Note**: MediaPipe is commented out in `requirements.txt` as it requires Python <3.14. Install it separately if using Python 3.11 or 3.12.

---

*Architecture details to be expanded as development progresses.*

